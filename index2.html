<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸êµ¬ë°€ì§‘ ëª¨ë‹ˆí„°ë§ ìƒí™©ì‹¤</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c1421, #1a2332);
            color: #00ff88;
            overflow: hidden;
            height: 100vh;
        }
        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-bottom: 2px solid #00ff88;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 1.5rem; text-shadow: 0 0 10px #00ff88; }
        .header-info { display: flex; gap: 20px; font-size: 0.9rem; }
        .status-indicator {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%;
            background: #00ff88; margin-right: 5px; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .main-container { display: flex; height: calc(100vh - 60px); }
        .camera-section { flex: 1; display: flex; flex-direction: column; padding: 10px; }
        .camera-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .camera-tab {
            padding: 8px 16px; background: rgba(0, 20, 40, 0.8);
            border: 2px solid #555; border-radius: 8px 8px 0 0;
            color: #999; cursor: pointer; transition: all 0.3s;
            font-weight: bold; font-size: 0.9rem;
        }
        .camera-tab.active {
            background: rgba(0, 255, 136, 0.2); border-color: #00ff88; color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }
        .camera-tab:hover { border-color: #00ff88; color: #00ff88; }
        .main-camera-panel {
            background: rgba(0, 20, 40, 0.8); border: 2px solid #00ff88;
            border-radius: 0 8px 8px 8px; position: relative; overflow: hidden;
            flex: 1; display: flex; flex-direction: column;
        }
        .main-camera-header {
            background: rgba(0, 255, 136, 0.2); padding: 12px 15px;
            font-size: 1.1rem; font-weight: bold; border-bottom: 1px solid #00ff88;
            display: flex; justify-content: space-between; align-items: center;
        }
        .main-camera-feed {
            flex: 1; background: #000; display: flex; align-items: center;
            justify-content: center; font-size: 1.5rem; color: #666;
            position: relative; min-height: 400px;
            padding: 5px;
        }
        .camera-offline { color: #ff4444; }
        .frame-info {
            font-size: 0.9rem; background: rgba(0, 0, 0, 0.7);
            padding: 4px 8px; border-radius: 3px;
        }
        
        /* ğŸ”¥ ì˜ìƒ ë° í´ë¦­ ê°€ëŠ¥í•œ êµ¬ì—­ ìŠ¤íƒ€ì¼ */
        .camera-video {
            max-width: 100%;
            max-height: 100%;
            min-width: 80%;
            min-height: 80%;
            object-fit: contain;
            border-radius: 4px;
            background-color: #000;
        }
        .video-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: #000;
            min-height: 300px;
            position: relative;
        }
        
        /* ğŸ”¥ í´ë¦­ ê°€ëŠ¥í•œ êµ¬ì—­ ì˜¤ë²„ë ˆì´ */
        .zone-overlay {
            position: absolute;
            background: rgba(0, 255, 136, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            opacity: 0.7;
        }
        .zone-overlay:hover {
            background: rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.8);
            transform: scale(1.02);
        }
        .zone-label {
            position: absolute;
            top: -25px;
            left: 5px;
            background: rgba(0, 255, 136, 0.9);
            color: #000;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        /* ğŸ”¥ íŒì—… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .popup-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .popup-content {
            background: rgba(0, 30, 60, 0.95);
            border: 3px solid #00ff88;
            border-radius: 10px;
            padding: 20px;
            max-width: 80%;
            max-height: 80%;
            position: relative;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        }
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #00ff88;
        }
        .popup-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 5px #00ff88;
        }
        .close-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .close-btn:hover {
            background: #ff6666;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }
        .popup-video {
            width: 600px;
            height: 400px;
            object-fit: contain;
            border-radius: 5px;
            background: #000;
        }
        
        .sidebar {
            width: 350px; background: rgba(0, 30, 60, 0.9);
            border-left: 2px solid #00ff88; padding: 20px; overflow-y: auto;
        }
        .stats-section { margin-bottom: 30px; }
        .stats-title {
            font-size: 1.2rem; font-weight: bold; margin-bottom: 15px;
            text-shadow: 0 0 5px #00ff88;
        }
        .stat-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; margin: 5px 0; background: rgba(0, 0, 0, 0.3);
            border-radius: 5px; border-left: 3px solid #00ff88;
        }
        .stat-value { font-size: 1.5rem; font-weight: bold; }
        .alert-section {
            background: rgba(255, 68, 68, 0.1); border: 1px solid #ff4444;
            border-radius: 8px; padding: 15px; margin: 15px 0;
        }
        .alert-title { color: #ff4444; font-weight: bold; margin-bottom: 10px; }
        .alert-item {
            background: rgba(255, 68, 68, 0.2); padding: 8px; margin: 5px 0;
            border-radius: 4px; font-size: 0.9rem;
        }
        .camera-controls {
            margin-top: 20px; padding: 15px; background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        .control-button {
            background: rgba(0, 255, 136, 0.2); border: 1px solid #00ff88;
            color: #00ff88; padding: 8px 15px; margin: 5px; border-radius: 4px;
            cursor: pointer; transition: all 0.3s;
        }
        .control-button:hover {
            background: rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        .timestamp { font-size: 0.8rem; opacity: 0.7; }
        
        /* ğŸ”¥ êµ¬ì—­ ì„¤ëª… íŒ¨ë„ */
        .zone-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            border-left: 3px solid #00ff88;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ” ì¸êµ¬ë°€ì§‘ ëª¨ë‹ˆí„°ë§ ìƒí™©ì‹¤</h1>
        <div class="header-info">
            <span><span class="status-indicator"></span>í™œì„± ì¹´ë©”ë¼: <span id="active-cameras">0</span></span>
            <span>ì´ íƒì§€ ì¸ì›: <span id="total-detections">0</span></span>
            <span class="timestamp" id="current-time">--</span>
        </div>
    </div>

    <div class="main-container">
        <div class="camera-section">
            <!-- ì¹´ë©”ë¼ ì„ íƒ íƒ­ -->
            <div class="camera-tabs">
                <div class="camera-tab active" onclick="switchCamera('main')" id="tab-main">MAIN</div>
                <div class="camera-tab" onclick="switchCamera(1)" id="tab-1">CAM 1</div>
                <div class="camera-tab" onclick="switchCamera(2)" id="tab-2">CAM 2</div>
                <div class="camera-tab" onclick="switchCamera(3)" id="tab-3">CAM 3</div>
                <div class="camera-tab" onclick="switchCamera(4)" id="tab-4">CAM 4</div>
            </div>

            <!-- ë©”ì¸ ì¹´ë©”ë¼ í™”ë©´ -->
            <div class="main-camera-panel">
                <div class="main-camera-header">
                    <span id="current-camera-title">ğŸ“¹ MAIN VIEW - ì „ì²´ í™”ë©´ (êµ¬ì—­ í´ë¦­ ê°€ëŠ¥)</span>
                    <div class="frame-info">Frame: <span id="current-frame">--</span></div>
                </div>
                <div class="main-camera-feed" id="main-camera-feed">
                    <div class="video-wrapper" id="video-wrapper">
                        <img src="/camera/main" 
                             class="camera-video" id="main-video"
                             onload="updateFrameInfo('main')"
                             onerror="handleVideoError('main')">
                        <!-- ğŸ”¥ í´ë¦­ ê°€ëŠ¥í•œ êµ¬ì—­ ì˜¤ë²„ë ˆì´ë“¤ (MAIN í™”ë©´ì—ì„œë§Œ í‘œì‹œ) -->
                        <div class="zone-overlay" id="zone-1" onclick="openZonePopup(1)" style="display: none;">
                            <div class="zone-label">ZONE 1</div>
                        </div>
                        <div class="zone-overlay" id="zone-2" onclick="openZonePopup(2)" style="display: none;">
                            <div class="zone-label">ZONE 2</div>
                        </div>
                        <div class="zone-overlay" id="zone-3" onclick="openZonePopup(3)" style="display: none;">
                            <div class="zone-label">ZONE 3</div>
                        </div>
                        <div class="zone-overlay" id="zone-4" onclick="openZonePopup(4)" style="display: none;">
                            <div class="zone-label">ZONE 4</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="stats-section">
                <div class="stats-title">ğŸ“Š ì‹¤ì‹œê°„ í†µê³„</div>
                <div class="stat-item"><span>Zone - 1</span><span class="stat-value" id="total-count">0</span></div>
                <div class="stat-item"><span>Zone - 2</span><span class="stat-value" id="current-count">0</span></div>
                <div class="stat-item"><span>Zone - 3</span><span class="stat-value" id="crowded-areas">0</span></div>
                <div class="stat-item"><span>Zone - 4</span><span class="stat-value" id="active-cams">0</span></div>
            </div>

            <div class="alert-section">
                <div class="alert-title">âš ï¸ ì‹¤ì‹œê°„ ì•Œë¦¼</div>
                <div id="alerts-container">
                    <div class="alert-item">ì‹œìŠ¤í…œ ëŒ€ê¸°ì¤‘...</div>
                </div>
            </div>

            <!-- ğŸ”¥ êµ¬ì—­ ì •ë³´ íŒ¨ë„ -->
            <div class="zone-info">
                <div class="stats-title">ğŸ¯ êµ¬ì—­ ì•ˆë‚´</div>
                <p style="font-size: 0.9rem; line-height: 1.4;">
                    MAIN í™”ë©´ì—ì„œ ì›í•˜ëŠ” êµ¬ì—­ì„ í´ë¦­í•˜ë©´<br>
                    í•´ë‹¹ êµ¬ì—­ì˜ ìƒì„¸ ëª¨ë‹ˆí„°ë§ ì°½ì´ íŒì—…ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.
                </p>
            </div>

            <div class="camera-controls">
                <div class="stats-title">ğŸ“¹ ì¹´ë©”ë¼ ìƒíƒœ</div>
                <button class="control-button" onclick="toggleCamera('main')">MAIN ON/OFF</button>
                <button class="control-button" onclick="toggleCamera(1)">CAM 1 ON/OFF</button>
                <button class="control-button" onclick="toggleCamera(2)">CAM 2 ON/OFF</button>
                <button class="control-button" onclick="toggleCamera(3)">CAM 3 ON/OFF</button>
                <button class="control-button" onclick="toggleCamera(4)">CAM 4 ON/OFF</button>
                <div style="margin-top: 15px;">
                    <button class="control-button" onclick="refreshAll()">ì „ì²´ ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ”¥ êµ¬ì—­ íŒì—… ëª¨ë‹¬ -->
    <div class="popup-modal" id="zone-popup">
        <div class="popup-content">
            <div class="popup-header">
                <div class="popup-title" id="popup-title">ğŸ“¹ ZONE 1 - ìƒì„¸ ëª¨ë‹ˆí„°ë§</div>
                <button class="close-btn" onclick="closeZonePopup()">âœ•</button>
            </div>
            <img class="popup-video" id="popup-video" src="">
        </div>
    </div>

    <script>
        // ğŸ”¥ êµ¬ì—­ ì¢Œí‘œ ì •ì˜ (app.pyì˜ ì‹¤ì œ ì¢Œí‘œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¡°ì •)
        // ì˜ìƒ í•´ìƒë„ê°€ ëŒ€ëµ 1280x720ì´ë¼ê³  ê°€ì •í•˜ê³  ê³„ì‚°
        const zoneCoords = {
            1: { left: '45.0%', top: '32.3%', width: '6.7%', height: '11.7%' },   // (866,326) â†’ (990,439)
            2: { left: '54.3%', top: '25.6%', width: '8.0%', height: '12.5%' },  // (1053,242) â†’ (1184,361)  
            3: { left: '0.4%', top: '55.4%', width: '20.8%', height: '30.5%' },   // (5,658) â†’ (374,1007)
            4: { left: '55.2%', top: '37.8%', width: '13.0%', height: '15.2%' }   // (1065,380) â†’ (1297,583)
        };

        // ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ko-KR', {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
            });
            document.getElementById('current-time').textContent = timeString;
        }

        // ğŸ”¥ êµ¬ì—­ ì˜¤ë²„ë ˆì´ í‘œì‹œ/ìˆ¨ê¹€
        function toggleZoneOverlays(show) {
            Object.keys(zoneCoords).forEach(zoneId => {
                const overlay = document.getElementById(`zone-${zoneId}`);
                if (show) {
                    const coords = zoneCoords[zoneId];
                    overlay.style.left = coords.left;
                    overlay.style.top = coords.top;
                    overlay.style.width = coords.width;
                    overlay.style.height = coords.height;
                    overlay.style.display = 'block';
                } else {
                    overlay.style.display = 'none';
                }
            });
        }

        // ì¹´ë©”ë¼ ì „í™˜ í•¨ìˆ˜
        let currentCamera = 'main';
        function switchCamera(cameraId) {
            // ì´ì „ íƒ­ ë¹„í™œì„±í™”
            const prevTab = document.getElementById(`tab-${currentCamera}`);
            if (prevTab) prevTab.classList.remove('active');
            
            // ìƒˆ íƒ­ í™œì„±í™”
            document.getElementById(`tab-${cameraId}`).classList.add('active');
            
            // ì œëª© ì—…ë°ì´íŠ¸
            let title = '';
            if (cameraId === 'main') {
                title = 'ğŸ“¹ MAIN VIEW - ì „ì²´ í™”ë©´ (êµ¬ì—­ í´ë¦­ ê°€ëŠ¥)';
                // ğŸ”¥ MAIN í™”ë©´ì—ì„œë§Œ êµ¬ì—­ ì˜¤ë²„ë ˆì´ í‘œì‹œ
                setTimeout(() => toggleZoneOverlays(true), 500);
            } else {
                title = `ğŸ“¹ PUBLIC CCTV ${cameraId} - CAM_0${cameraId}`;
                // ğŸ”¥ ê°œë³„ ì¹´ë©”ë¼ì—ì„œëŠ” êµ¬ì—­ ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
                toggleZoneOverlays(false);
            }
            document.getElementById('current-camera-title').textContent = title;
            
            // ì˜ìƒ ìŠ¤íŠ¸ë¦¼ ì—…ë°ì´íŠ¸
            const feedElement = document.getElementById('main-camera-feed');
            feedElement.innerHTML = `
                <div class="video-wrapper" id="video-wrapper">
                    <img src="/camera/${cameraId}" 
                         class="camera-video" id="main-video"
                         onload="updateFrameInfo('${cameraId}')"
                         onerror="handleVideoError('${cameraId}')">
                    <!-- êµ¬ì—­ ì˜¤ë²„ë ˆì´ë“¤ -->
                    <div class="zone-overlay" id="zone-1" onclick="openZonePopup(1)" style="display: none;">
                        <div class="zone-label">ZONE 1</div>
                    </div>
                    <div class="zone-overlay" id="zone-2" onclick="openZonePopup(2)" style="display: none;">
                        <div class="zone-label">ZONE 2</div>
                    </div>
                    <div class="zone-overlay" id="zone-3" onclick="openZonePopup(3)" style="display: none;">
                        <div class="zone-label">ZONE 3</div>
                    </div>
                    <div class="zone-overlay" id="zone-4" onclick="openZonePopup(4)" style="display: none;">
                        <div class="zone-label">ZONE 4</div>
                    </div>
                </div>`;
            feedElement.classList.remove('camera-offline');
            currentCamera = cameraId;
            
            // MAIN í™”ë©´ì´ë©´ ì ì‹œ í›„ ì˜¤ë²„ë ˆì´ í‘œì‹œ
            if (cameraId === 'main') {
                setTimeout(() => {
                    const videoElement = document.getElementById('main-video');
                    if (videoElement) {
                        // ì˜ìƒ ë¡œë”© ì™„ë£Œ ëŒ€ê¸° í›„ êµ¬ì—­ ì˜¤ë²„ë ˆì´ í‘œì‹œ
                        if (videoElement.complete) {
                            calculateZonePosition(videoElement);
                        } else {
                            videoElement.onload = () => calculateZonePosition(videoElement);
                        }
                    }
                }, 500);
            }
        }

        // ğŸ”¥ êµ¬ì—­ íŒì—… ì—´ê¸°
        function openZonePopup(zoneId) {
            const popup = document.getElementById('zone-popup');
            const popupTitle = document.getElementById('popup-title');
            const popupVideo = document.getElementById('popup-video');
            
            popupTitle.textContent = `ğŸ“¹ ZONE ${zoneId} - ìƒì„¸ ëª¨ë‹ˆí„°ë§`;
            popupVideo.src = `/camera/${zoneId}`;
            popup.style.display = 'flex';
            
            console.log(`ZONE ${zoneId} íŒì—… ì—´ë¦¼`);
        }

        // ğŸ”¥ êµ¬ì—­ íŒì—… ë‹«ê¸°
        function closeZonePopup() {
            const popup = document.getElementById('zone-popup');
            const popupVideo = document.getElementById('popup-video');
            
            popup.style.display = 'none';
            popupVideo.src = ''; // ì˜ìƒ ìŠ¤íŠ¸ë¦¼ ì •ì§€
        }

        // ğŸ”¥ ESC í‚¤ë¡œ íŒì—… ë‹«ê¸°
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeZonePopup();
            }
        });

        // ğŸ”¥ íŒì—… ë°”ê¹¥ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
        document.getElementById('zone-popup').addEventListener('click', function(event) {
            if (event.target === this) {
                closeZonePopup();
            }
        });

        function updateFrameInfo(cameraId) {
            if (cameraId === 'main') {
                document.getElementById('current-frame').textContent = 'Live - MAIN';
            } else {
                document.getElementById('current-frame').textContent = `Live - CAM_0${cameraId}`;
            }
        }
        
        function handleVideoError(cameraId) {
            const feedElement = document.getElementById('main-camera-feed');
            const errorMsg = cameraId === 'main' ? 'MAIN VIEW' : `ì¹´ë©”ë¼ ${cameraId}`;
            feedElement.innerHTML = `<div style="color:#ff4444;">ğŸ“¹ ${errorMsg} ì—°ê²° ì‹¤íŒ¨</div>`;
        }

        // API ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchStats() {
            try {
                const response = await fetch('/api/detection_stats');
                const data = await response.json();
                document.getElementById('total-count').textContent = data.total_detections || 0;
                document.getElementById('active-cams').textContent = data.active_cameras || 0;
                document.getElementById('active-cameras').textContent = data.active_cameras || 0;
                document.getElementById('total-detections').textContent = data.total_detections || 0;
            } catch (e) { console.log('í†µê³„ ëŒ€ê¸°ì¤‘...'); }
        }

        async function fetchAlerts() {
            try {
                const response = await fetch('/api/alerts');
                const data = await response.json();
                const alertsContainer = document.getElementById('alerts-container');
                if (data.alerts && data.alerts.length > 0) {
                    alertsContainer.innerHTML = data.alerts.map(alert =>
                        `<div class="alert-item">${alert}</div>`).join('');
                }
            } catch (e) { console.log('ì•Œë¦¼ ëŒ€ê¸°ì¤‘...'); }
        }

        function toggleCamera(cameraId) { console.log(`ì¹´ë©”ë¼ ${cameraId} í† ê¸€`); }
        function refreshAll() { 
            fetchStats(); 
            fetchAlerts(); 
            switchCamera(currentCamera);
        }

        // ì£¼ê¸°ì  ì—…ë°ì´íŠ¸
        setInterval(updateTime, 1000);
        setInterval(fetchStats, 5000);
        setInterval(fetchAlerts, 10000);

        // ì´ˆê¸° ë¡œë“œ
        updateTime(); 
        fetchStats(); 
        fetchAlerts(); 
        switchCamera('main');
    </script>
</body>
</html>