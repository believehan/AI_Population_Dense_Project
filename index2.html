<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïù∏Íµ¨Î∞ÄÏßë Î™®ÎãàÌÑ∞ÎßÅ ÏÉÅÌô©Ïã§</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c1421, #1a2332);
            color: #00ff88;
            overflow: hidden;
            height: 100vh;
        }
        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-bottom: 2px solid #00ff88;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 1.5rem; text-shadow: 0 0 10px #00ff88; }
        .header-info { display: flex; gap: 20px; font-size: 0.9rem; }
        .status-indicator {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%;
            background: #00ff88; margin-right: 5px; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .main-container { display: flex; height: calc(100vh - 60px); }
        .camera-section { flex: 1; display: flex; flex-direction: column; padding: 10px; }
        .camera-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .camera-tab {
            padding: 8px 16px; background: rgba(0, 20, 40, 0.8);
            border: 2px solid #555; border-radius: 8px 8px 0 0;
            color: #999; cursor: pointer; transition: all 0.3s;
            font-weight: bold; font-size: 0.9rem;
        }
        .camera-tab.active {
            background: rgba(0, 255, 136, 0.2); border-color: #00ff88; color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }
        .camera-tab:hover { border-color: #00ff88; color: #00ff88; }
        .main-camera-panel {
            background: rgba(0, 20, 40, 0.8); border: 2px solid #00ff88;
            border-radius: 0 8px 8px 8px; position: relative; overflow: hidden;
            flex: 1; display: flex; flex-direction: column;
        }
        .main-camera-header {
            background: rgba(0, 255, 136, 0.2); padding: 12px 15px;
            font-size: 1.1rem; font-weight: bold; border-bottom: 1px solid #00ff88;
            display: flex; justify-content: space-between; align-items: center;
        }
        .main-camera-feed {
            flex: 1; background: #000; display: flex; align-items: center;
            justify-content: center; font-size: 1.5rem; color: #666;
            position: relative; min-height: 400px;
            padding: 5px;
        }
        .camera-offline { color: #ff4444; }
        .frame-info {
            font-size: 0.9rem; background: rgba(0, 0, 0, 0.7);
            padding: 4px 8px; border-radius: 3px;
        }
        
        /* üî• ÏòÅÏÉÅ Î∞è ÌÅ¥Î¶≠ Í∞ÄÎä•Ìïú Íµ¨Ïó≠ Ïä§ÌÉÄÏùº */
        .camera-video {
            max-width: 100%;
            max-height: 100%;
            min-width: 80%;
            min-height: 80%;
            object-fit: contain;
            border-radius: 4px;
            background-color: #000;
        }
        .video-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: #000;
            min-height: 300px;
            position: relative;
        }
        
        /* üî• ÌÅ¥Î¶≠ Í∞ÄÎä•Ìïú Íµ¨Ïó≠ Ïò§Î≤ÑÎ†àÏù¥ */
        .zone-overlay {
            position: absolute;
            background: rgba(0, 255, 136, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            opacity: 0.7;
        }
        .zone-overlay:hover {
            background: rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.8);
            transform: scale(1.02);
        }
        .zone-label {
            position: absolute;
            top: -25px;
            left: 5px;
            background: rgba(0, 255, 136, 0.9);
            color: #000;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        /* üî• ÌåùÏóÖ Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .popup-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .popup-content {
            background: rgba(0, 30, 60, 0.95);
            border: 3px solid #00ff88;
            border-radius: 10px;
            padding: 20px;
            max-width: 80%;
            max-height: 80%;
            position: relative;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        }
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #00ff88;
        }
        .popup-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 5px #00ff88;
        }
        .close-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .close-btn:hover {
            background: #ff6666;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }
        .popup-video {
            width: 600px;
            height: 400px;
            object-fit: contain;
            border-radius: 5px;
            background: #000;
        }
        
        .sidebar {
            width: 350px; background: rgba(0, 30, 60, 0.9);
            border-left: 2px solid #00ff88; padding: 20px; overflow-y: auto;
        }
        .stats-section { margin-bottom: 30px; }
        .stats-title {
            font-size: 1.2rem; font-weight: bold; margin-bottom: 15px;
            text-shadow: 0 0 5px #00ff88;
        }
        .stat-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; margin: 5px 0; background: rgba(0, 0, 0, 0.3);
            border-radius: 5px; border-left: 3px solid #00ff88;
        }
        .stat-value { font-size: 1.5rem; font-weight: bold; }
        .alert-section {
            background: rgba(255, 68, 68, 0.1); border: 1px solid #ff4444;
            border-radius: 8px; padding: 15px; margin: 15px 0;
        }
        .alert-title { color: #ff4444; font-weight: bold; margin-bottom: 10px; }
        .alert-item {
            background: rgba(255, 68, 68, 0.2); padding: 8px; margin: 5px 0;
            border-radius: 4px; font-size: 0.9rem;
        }
        .camera-controls {
            margin-top: 20px; padding: 15px; background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        .control-button {
            background: rgba(0, 255, 136, 0.2); border: 1px solid #00ff88;
            color: #00ff88; padding: 8px 15px; margin: 5px; border-radius: 4px;
            cursor: pointer; transition: all 0.3s;
        }
        .control-button:hover {
            background: rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        .timestamp { font-size: 0.8rem; opacity: 0.7; }
        
        /* üî• Íµ¨Ïó≠ ÏÑ§Î™Ö Ìå®ÎÑê */
        .zone-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            border-left: 3px solid #00ff88;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Ïù∏Íµ¨Î∞ÄÏßë Î™®ÎãàÌÑ∞ÎßÅ ÏÉÅÌô©Ïã§</h1>
        <div class="header-info">
            <span><span class="status-indicator"></span>ÌôúÏÑ± Ïπ¥Î©îÎùº: <span id="active-cameras">0</span></span>
            <span>Ï¥ù ÌÉêÏßÄ Ïù∏Ïõê: <span id="total-detections">0</span></span>
            <span class="timestamp" id="current-time">--</span>
        </div>
    </div>

    <div class="main-container">
        <div class="camera-section">
            <!-- Ïπ¥Î©îÎùº ÏÑ†ÌÉù ÌÉ≠ -->
            <div class="camera-tabs">
                <div class="camera-tab active" onclick="switchCamera('main')" id="tab-main">MAIN</div>
                <div class="camera-tab" onclick="switchCamera(1)" id="tab-1">CAM 1</div>
                <div class="camera-tab" onclick="switchCamera(2)" id="tab-2">CAM 2</div>
                <div class="camera-tab" onclick="switchCamera(3)" id="tab-3">CAM 3</div>
                <div class="camera-tab" onclick="switchCamera(4)" id="tab-4">CAM 4</div>
            </div>

            <!-- Î©îÏù∏ Ïπ¥Î©îÎùº ÌôîÎ©¥ -->
            <div class="main-camera-panel">
                <div class="main-camera-header">
                    <span id="current-camera-title">üìπ MAIN VIEW - Ï†ÑÏ≤¥ ÌôîÎ©¥ (Íµ¨Ïó≠ ÌÅ¥Î¶≠ Í∞ÄÎä•)</span>
                    <div class="frame-info">Frame: <span id="current-frame">--</span></div>
                </div>
                <div class="main-camera-feed" id="main-camera-feed">
                    <div class="video-wrapper" id="video-wrapper">
                        <img src="/camera/main" 
                             class="camera-video" id="main-video"
                             onload="updateFrameInfo('main')"
                             onerror="handleVideoError('main')">
                        <!-- üî• ÌÅ¥Î¶≠ Í∞ÄÎä•Ìïú Íµ¨Ïó≠ Ïò§Î≤ÑÎ†àÏù¥Îì§ (MAIN ÌôîÎ©¥ÏóêÏÑúÎßå ÌëúÏãú) -->
                        <div class="zone-overlay" id="zone-1" onclick="openZonePopup(1)" style="display: none;">
                            <div class="zone-label">ZONE 1</div>
                        </div>
                        <div class="zone-overlay" id="zone-2" onclick="openZonePopup(2)" style="display: none;">
                            <div class="zone-label">ZONE 2</div>
                        </div>
                        <div class="zone-overlay" id="zone-3" onclick="openZonePopup(3)" style="display: none;">
                            <div class="zone-label">ZONE 3</div>
                        </div>
                        <div class="zone-overlay" id="zone-4" onclick="openZonePopup(4)" style="display: none;">
                            <div class="zone-label">ZONE 4</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="stats-section">
                <div class="stats-title">üìä Ïã§ÏãúÍ∞Ñ ÌÜµÍ≥Ñ</div>
                <div class="stat-item"><span>Zone - 1</span><span class="stat-value" id="total-count">0</span></div>
                <div class="stat-item"><span>Zone - 2</span><span class="stat-value" id="current-count">0</span></div>
                <div class="stat-item"><span>Zone - 3</span><span class="stat-value" id="crowded-areas">0</span></div>
                <div class="stat-item"><span>Zone - 4</span><span class="stat-value" id="active-cams">0</span></div>
            </div>

            <div class="alert-section">
                <div class="alert-title">‚ö†Ô∏è Ïã§ÏãúÍ∞Ñ ÏïåÎ¶º</div>
                <div id="alerts-container">
                    <div class="alert-item">ÏãúÏä§ÌÖú ÎåÄÍ∏∞Ï§ë...</div>
                </div>
            </div>

            <!-- üî• Íµ¨Ïó≠ Ï†ïÎ≥¥ Ìå®ÎÑê -->
            <div class="zone-info">
                <div class="stats-title">üéØ Íµ¨Ïó≠ ÏïàÎÇ¥</div>
                <p style="font-size: 0.9rem; line-height: 1.4;">
                    MAIN ÌôîÎ©¥ÏóêÏÑú ÏõêÌïòÎäî Íµ¨Ïó≠ÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥<br>
                    Ìï¥Îãπ Íµ¨Ïó≠Ïùò ÏÉÅÏÑ∏ Î™®ÎãàÌÑ∞ÎßÅ Ï∞ΩÏù¥ ÌåùÏóÖÏúºÎ°ú Ïó¥Î¶ΩÎãàÎã§.
                </p>
            </div>

            <div class="camera-controls">
                <div class="stats-title">üìπ Ïπ¥Î©îÎùº ÏÉÅÌÉú</div>
                <button class="control-button" onclick="toggleCamera('main')">MAIN ON/OFF</button>
                <button class="control-button" onclick="toggleCamera(1)">CAM 1 ON/OFF</button>
                <button class="control-button" onclick="toggleCamera(2)">CAM 2 ON/OFF</button>
                <button class="control-button" onclick="toggleCamera(3)">CAM 3 ON/OFF</button>
                <button class="control-button" onclick="toggleCamera(4)">CAM 4 ON/OFF</button>
                <div style="margin-top: 15px;">
                    <button class="control-button" onclick="refreshAll()">Ï†ÑÏ≤¥ ÏÉàÎ°úÍ≥†Ïπ®</button>
                </div>
            </div>
        </div>
    </div>

    <!-- üî• Íµ¨Ïó≠ ÌåùÏóÖ Î™®Îã¨ -->
    <div class="popup-modal" id="zone-popup">
        <div class="popup-content">
            <div class="popup-header">
                <div class="popup-title" id="popup-title">üìπ ZONE 1 - ÏÉÅÏÑ∏ Î™®ÎãàÌÑ∞ÎßÅ</div>
                <button class="close-btn" onclick="closeZonePopup()">‚úï</button>
            </div>
            <img class="popup-video" id="popup-video" src="">
        </div>
    </div>

    <script>
        // üî• Íµ¨Ïó≠ Ï¢åÌëú Ï†ïÏùò (app.pyÏùò Ïã§Ï†ú Ï¢åÌëúÎ•º Í∏∞Î∞òÏúºÎ°ú Ï°∞Ï†ï)
        // ÏòÅÏÉÅ Ìï¥ÏÉÅÎèÑÍ∞Ä ÎåÄÎûµ 1280x720Ïù¥ÎùºÍ≥† Í∞ÄÏ†ïÌïòÍ≥† Í≥ÑÏÇ∞
        const zoneCoords = {
            1: { left: '45.0%', top: '32.3%', width: '6.7%', height: '11.7%' },   // (866,326) ‚Üí (990,439)
            2: { left: '54.3%', top: '25.6%', width: '8.0%', height: '12.5%' },  // (1053,242) ‚Üí (1184,361)  
            3: { left: '0.4%', top: '55.4%', width: '20.8%', height: '30.5%' },   // (5,658) ‚Üí (374,1007)
            4: { left: '55.2%', top: '37.8%', width: '13.0%', height: '15.2%' }   // (1065,380) ‚Üí (1297,583)
        };

        // ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ko-KR', {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
            });
            document.getElementById('current-time').textContent = timeString;
        }

        // üî• Íµ¨Ïó≠ Ïò§Î≤ÑÎ†àÏù¥ ÌëúÏãú/Ïà®ÍπÄ
        function toggleZoneOverlays(show) {
            Object.keys(zoneCoords).forEach(zoneId => {
                const overlay = document.getElementById(`zone-${zoneId}`);
                if (show) {
                    const coords = zoneCoords[zoneId];
                    overlay.style.left = coords.left;
                    overlay.style.top = coords.top;
                    overlay.style.width = coords.width;
                    overlay.style.height = coords.height;
                    overlay.style.display = 'block';
                } else {
                    overlay.style.display = 'none';
                }
            });
        }

        // Ïπ¥Î©îÎùº Ï†ÑÌôò Ìï®Ïàò
        let currentCamera = 'main';
        function switchCamera(cameraId) {
            // Ïù¥Ï†Ñ ÌÉ≠ ÎπÑÌôúÏÑ±Ìôî
            const prevTab = document.getElementById(`tab-${currentCamera}`);
            if (prevTab) prevTab.classList.remove('active');
            
            // ÏÉà ÌÉ≠ ÌôúÏÑ±Ìôî
            document.getElementById(`tab-${cameraId}`).classList.add('active');
            
            // Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
            let title = '';
            if (cameraId === 'main') {
                title = 'üìπ MAIN VIEW - Ï†ÑÏ≤¥ ÌôîÎ©¥ (Íµ¨Ïó≠ ÌÅ¥Î¶≠ Í∞ÄÎä•)';
                // üî• MAIN ÌôîÎ©¥ÏóêÏÑúÎßå Íµ¨Ïó≠ Ïò§Î≤ÑÎ†àÏù¥ ÌëúÏãú
                setTimeout(() => toggleZoneOverlays(true), 500);
            } else {
                title = `üìπ PUBLIC CCTV ${cameraId} - CAM_0${cameraId}`;
                // üî• Í∞úÎ≥Ñ Ïπ¥Î©îÎùºÏóêÏÑúÎäî Íµ¨Ïó≠ Ïò§Î≤ÑÎ†àÏù¥ Ïà®ÍπÄ
                toggleZoneOverlays(false);
            }
            document.getElementById('current-camera-title').textContent = title;
            
            // ÏòÅÏÉÅ Ïä§Ìä∏Î¶º ÏóÖÎç∞Ïù¥Ìä∏
            const feedElement = document.getElementById('main-camera-feed');
            feedElement.innerHTML = `
                <div class="video-wrapper" id="video-wrapper">
                    <img src="/camera/${cameraId}" 
                         class="camera-video" id="main-video"
                         onload="updateFrameInfo('${cameraId}')"
                         onerror="handleVideoError('${cameraId}')">
                    <!-- Íµ¨Ïó≠ Ïò§Î≤ÑÎ†àÏù¥Îì§ -->
                    <div class="zone-overlay" id="zone-1" onclick="openZonePopup(1)" style="display: none;">
                        <div class="zone-label">ZONE 1</div>
                    </div>
                    <div class="zone-overlay" id="zone-2" onclick="openZonePopup(2)" style="display: none;">
                        <div class="zone-label">ZONE 2</div>
                    </div>
                    <div class="zone-overlay" id="zone-3" onclick="openZonePopup(3)" style="display: none;">
                        <div class="zone-label">ZONE 3</div>
                    </div>
                    <div class="zone-overlay" id="zone-4" onclick="openZonePopup(4)" style="display: none;">
                        <div class="zone-label">ZONE 4</div>
                    </div>
                </div>`;
            feedElement.classList.remove('camera-offline');
            currentCamera = cameraId;
            
            // MAIN ÌôîÎ©¥Ïù¥Î©¥ Ïû†Ïãú ÌõÑ Ïò§Î≤ÑÎ†àÏù¥ ÌëúÏãú
            if (cameraId === 'main') {
                setTimeout(() => {
                    const videoElement = document.getElementById('main-video');
                    if (videoElement) {
                        // ÏòÅÏÉÅ Î°úÎî© ÏôÑÎ£å ÎåÄÍ∏∞ ÌõÑ Íµ¨Ïó≠ Ïò§Î≤ÑÎ†àÏù¥ ÌëúÏãú
                        if (videoElement.complete) {
                            calculateZonePosition(videoElement);
                        } else {
                            videoElement.onload = () => calculateZonePosition(videoElement);
                        }
                    }
                }, 500);
            }
        }

        // üî• Íµ¨Ïó≠ ÌåùÏóÖ Ïó¥Í∏∞
        function openZonePopup(zoneId) {
            const popup = document.getElementById('zone-popup');
            const popupTitle = document.getElementById('popup-title');
            const popupVideo = document.getElementById('popup-video');
            
            popupTitle.textContent = `üìπ ZONE ${zoneId} - ÏÉÅÏÑ∏ Î™®ÎãàÌÑ∞ÎßÅ`;
            popupVideo.src = `/camera/${zoneId}`;
            popup.style.display = 'flex';
            
            console.log(`ZONE ${zoneId} ÌåùÏóÖ Ïó¥Î¶º`);
        }

        // üî• Íµ¨Ïó≠ ÌåùÏóÖ Îã´Í∏∞
        function closeZonePopup() {
            const popup = document.getElementById('zone-popup');
            const popupVideo = document.getElementById('popup-video');
            
            popup.style.display = 'none';
            popupVideo.src = ''; // ÏòÅÏÉÅ Ïä§Ìä∏Î¶º Ï†ïÏßÄ
        }

        // üî• ESC ÌÇ§Î°ú ÌåùÏóÖ Îã´Í∏∞
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeZonePopup();
            }
        });

        // üî• ÌåùÏóÖ Î∞îÍπ• ÌÅ¥Î¶≠ÏúºÎ°ú Îã´Í∏∞
        document.getElementById('zone-popup').addEventListener('click', function(event) {
            if (event.target === this) {
                closeZonePopup();
            }
        });

        function updateFrameInfo(cameraId) {
            if (cameraId === 'main') {
                document.getElementById('current-frame').textContent = 'Live - MAIN';
            } else {
                document.getElementById('current-frame').textContent = `Live - CAM_0${cameraId}`;
            }
        }
        
        function handleVideoError(cameraId) {
            const feedElement = document.getElementById('main-camera-feed');
            const errorMsg = cameraId === 'main' ? 'MAIN VIEW' : `Ïπ¥Î©îÎùº ${cameraId}`;
            feedElement.innerHTML = `<div style="color:#ff4444;">üìπ ${errorMsg} Ïó∞Í≤∞ Ïã§Ìå®</div>`;
        }

        // API Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        async function fetchStats() {
            try {
                const response = await fetch('/api/detection_stats');
                const data = await response.json();
                document.getElementById('total-count').textContent = data.total_detections || 0;
                document.getElementById('active-cams').textContent = data.active_cameras || 0;
                document.getElementById('active-cameras').textContent = data.active_cameras || 0;
                document.getElementById('total-detections').textContent = data.total_detections || 0;
            } catch (e) { console.log('ÌÜµÍ≥Ñ ÎåÄÍ∏∞Ï§ë...'); }
        }

        async function fetchAlerts() {
            try {
                const response = await fetch('/api/alerts');
                const data = await response.json();
                const alertsContainer = document.getElementById('alerts-container');
                if (data.alerts && data.alerts.length > 0) {
                    alertsContainer.innerHTML = data.alerts.map(alert =>
                        `<div class="alert-item">${alert}</div>`).join('');
                }
            } catch (e) { console.log('ÏïåÎ¶º ÎåÄÍ∏∞Ï§ë...'); }
        }

        function toggleCamera(cameraId) { console.log(`Ïπ¥Î©îÎùº ${cameraId} ÌÜ†Í∏Ä`); }
        function refreshAll() { 
            fetchStats(); 
            fetchAlerts(); 
            switchCamera(currentCamera);
        }

        // Ï£ºÍ∏∞Ï†Å ÏóÖÎç∞Ïù¥Ìä∏
        setInterval(updateTime, 1000);
        setInterval(fetchStats, 5000);
        setInterval(fetchAlerts, 10000);

        // Ï¥àÍ∏∞ Î°úÎìú
        updateTime(); 
        fetchStats(); 
        fetchAlerts(); 
        switchCamera('main');
    </script>
</body>
</html>